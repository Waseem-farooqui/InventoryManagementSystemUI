<div class="row">
  <div class="col-12">
    <div class="page-title-box d-flex align-items-center justify-content-between">
      <h4 class="mb-0 font-size-18">Purchase Items</h4>
      <h4></h4>
      <div class="page-title-right">
        <ol class="breadcrumb m-0">
          <li class="breadcrumb-item"><a (click)="home()">Home</a></li>
          <li class="breadcrumb-item active">Purchase Item</li>
        </ol>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-lg-12">
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <a class="nav-link active" id="contact-tab" data-toggle="tab" href="#contact" role="tab" aria-controls="contact"
           aria-selected="false">Detail</a>
      </li>
      <li class="nav-item" role="presentation">
        <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile"
           aria-selected="false">List</a>
      </li>
    </ul>
    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active" id="contact" role="tabpanel" aria-labelledby="contact-tab">
        <div class="row">
          <div class="col-md-12">
            <div class="job-form job-form-b" (click)="hotclick()">
              <form class="needs-validation" [formGroup]="purchaseForm" (ngSubmit)="onSubmit()">
                <div class="form-row">
                  <div class="form-group col-md-2">
                    <input type="number" formControlName="invoice" placeholder="Invoice NO:" class="form-control"
                           readonly
                           [ngClass]="{ 'is-invalid': (submitted && itemsAddsFormControl.invoice.errors) || ((itemsAddsFormControl.invoice.dirty || itemsAddsFormControl.invoice.touched) && itemsAddsFormControl.invoice.errors) }"/>
                    <div *ngIf="itemsAddsFormControl.invoice.errors" class="invalid-feedback">
                      <div
                        *ngIf="(itemsAddsFormControl.invoice.dirty || itemsAddsFormControl.invoice.touched) && itemsAddsFormControl.invoice.errors?.pattern">
                        Please enter a valid invoice
                      </div>
                      <div
                        *ngIf="((itemsAddsFormControl.invoice.dirty || itemsAddsFormControl.invoice.touched) && itemsAddsFormControl.invoice.errors?.required && !itemsAddsFormControl.invoice.errors?.pattern && !submitted)">
                        invoice no is required
                      </div>
                      <div
                        *ngIf="((submitted) && itemsAddsFormControl.invoice.errors?.required && !itemsAddsFormControl.invoice.errors?.pattern)">
                        invoice No is required
                      </div>
                    </div>
                  </div>
                  <div class="form-group col-md-4">
                    <input type="date" formControlName="purchaseDate" placeholder="purchaseDate" class="form-control"
                           value="{{today | date:'dd-MM-yyyy hh:mm:ss a':'+0530'}}"
                           [ngClass]="{ 'is-invalid': (submitted && itemsAddsFormControl.purchaseDate.errors) || ((itemsAddsFormControl.purchaseDate.dirty || itemsAddsFormControl.purchaseDate.touched) && itemsAddsFormControl.purchaseDate.errors) }"/>
                    <div *ngIf="itemsAddsFormControl.purchaseDate.errors" class="invalid-feedback">
                      <div
                        *ngIf="(itemsAddsFormControl.purchaseDate.dirty || itemsAddsFormControl.purchaseDate.touched) && itemsAddsFormControl.purchaseDate.errors?.pattern">
                        Please enter a valid Purchase Date
                      </div>
                      <div
                        *ngIf="((itemsAddsFormControl.purchaseDate.dirty || itemsAddsFormControl.purchaseDate.touched) && itemsAddsFormControl.purchaseDate.errors?.required && !itemsAddsFormControl.purchaseDate.errors?.pattern && !submitted)">
                        Purchase Date no is required
                      </div>
                      <div
                        *ngIf="((submitted) && itemsAddsFormControl.purchaseDate.errors?.required && !itemsAddsFormControl.purchaseDate.errors?.pattern)">
                        Purchase Date No is required
                      </div>
                    </div>
                  </div>
                  <div class="form-group col-md-2">
                    <input type="text" formControlName="goDown" placeholder="Go Down" class="form-control" readonly

                           [ngClass]="{ 'is-invalid': (submitted && itemsAddsFormControl.goDown.errors) || ((itemsAddsFormControl.goDown.dirty || itemsAddsFormControl.goDown.touched) && itemsAddsFormControl.goDown.errors) }"/>
                    <div *ngIf="itemsAddsFormControl.goDown.errors" class="invalid-feedback">
                      <div
                        *ngIf="(itemsAddsFormControl.goDown.dirty || itemsAddsFormControl.goDown.touched) && itemsAddsFormControl.goDown.errors?.pattern">
                        Please enter a valid GoDown
                      </div>
                      <div
                        *ngIf="((itemsAddsFormControl.goDown.dirty || itemsAddsFormControl.goDown.touched) && itemsAddsFormControl.goDown.errors?.required && !itemsAddsFormControl.goDown.errors?.pattern && !submitted)">
                        Go Down no is required
                      </div>
                      <div
                        *ngIf="((submitted) && itemsAddsFormControl.goDown.errors?.required && !itemsAddsFormControl.goDown.errors?.pattern)">
                        Go Down No is required
                      </div>
                    </div>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-3">
                    <input type="text" formControlName="aliasName" placeholder="Alias Name:" class="form-control"
                           readonly
                           [ngClass]="{ 'is-invalid': (submitted && itemsAddsFormControl.aliasName.errors) || ((itemsAddsFormControl.aliasName.dirty || itemsAddsFormControl.aliasName.touched) && itemsAddsFormControl.aliasName.errors) }"/>
                    <div *ngIf="itemsAddsFormControl.aliasName.errors" class="invalid-feedback">
                      <div
                        *ngIf="(itemsAddsFormControl.aliasName.dirty || itemsAddsFormControl.aliasName.touched) && itemsAddsFormControl.aliasName.errors?.pattern">
                        Please enter a valid aliasName
                      </div>
                      <div
                        *ngIf="((itemsAddsFormControl.aliasName.dirty || itemsAddsFormControl.aliasName.touched) && itemsAddsFormControl.aliasName.errors?.required && !itemsAddsFormControl.aliasName.errors?.pattern && !submitted)">
                        aliasName no is required
                      </div>
                      <div
                        *ngIf="((submitted) && itemsAddsFormControl.aliasName.errors?.required && !itemsAddsFormControl.aliasName.errors?.pattern)">
                        aliasName No is required
                      </div>
                    </div>
                  </div>
                  <div class="form-group col-md-6">
                    <p-autoComplete placeholder="Supplier Name:" formControlName="supplierName"
                                    [suggestions]="supplierLookUpNameResult"
                                    [ngClass]="{ 'is-invalid': (submitted && itemsAddsFormControl.supplierName.errors)
                                    || ((itemsAddsFormControl.supplierName.dirty
                                          || itemsAddsFormControl.supplierName.touched) && itemsAddsFormControl.supplierName.errors) }"
                                    (completeMethod)="searchSupplier($event)" [dropdown]="true"
                                    (onSelect)="supplierNameOnSelect(itemsAddsFormControl.supplierName)">
                      <ng-template let-profileClassification pTemplate="item">
                        {{profileClassification }}
                      </ng-template>
                    </p-autoComplete>
                    <div *ngIf="itemsAddsFormControl.supplierName.errors" class="invalid-feedback">
                      <div
                        *ngIf="((itemsAddsFormControl.supplierName.dirty || itemsAddsFormControl.supplierName.touched) && itemsAddsFormControl.supplierName.errors?.required && !itemsAddsFormControl.supplierName.errors?.pattern && !submitted)">
                        Supplier Name is required
                      </div>
                      <div
                        *ngIf="((submitted) && itemsAddsFormControl.supplierName.errors?.required && !itemsAddsFormControl.supplierName.errors?.pattern)">
                        Supplier Name is required
                      </div>
                    </div>

                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-4">

                    <input type="text" formControlName="supplierInvoiceNumber"
                           placeholder="supplierInvoiceNumber"
                           class="form-control"
                           [ngClass]="{ 'is-invalid': (submitted && itemsAddsFormControl.supplierInvoiceNumber.errors) || ((itemsAddsFormControl.supplierInvoiceNumber.dirty || itemsAddsFormControl.supplierInvoiceNumber.touched) && itemsAddsFormControl.supplierInvoiceNumber.errors) }"/>
                    <div *ngIf="itemsAddsFormControl.supplierInvoiceNumber.errors" class="invalid-feedback">
                      <div
                        *ngIf="(itemsAddsFormControl.supplierInvoiceNumber.dirty || itemsAddsFormControl.supplierInvoiceNumber.touched) && itemsAddsFormControl.supplierInvoiceNumber.errors?.pattern">
                        Please enter a valid supplierInvoiceNumber
                      </div>
                      <div
                        *ngIf="((itemsAddsFormControl.supplierInvoiceNumber.dirty || itemsAddsFormControl.supplierInvoiceNumber.touched) && itemsAddsFormControl.supplierInvoiceNumber.errors?.required && !itemsAddsFormControl.supplierInvoiceNumber.errors?.pattern && !submitted)">
                        Supplier Invoice Number is required
                      </div>
                      <div
                        *ngIf="((submitted) && itemsAddsFormControl.supplierInvoiceNumber.errors?.required && !itemsAddsFormControl.supplierInvoiceNumber.errors?.pattern)">
                        Supplier Invoice Number is required
                      </div>
                    </div>
                  </div>
                  <div class="form-group col-md-2">

                    <input type="text" formControlName="grnNumber" placeholder="GRN # :" class="form-control"
                           [ngClass]="{ 'is-invalid': (submitted && itemsAddsFormControl.grnNumber.errors) || ((itemsAddsFormControl.grnNumber.dirty || itemsAddsFormControl.grnNumber.touched) && itemsAddsFormControl.grnNumber.errors) }"/>
                    <div *ngIf="itemsAddsFormControl.grnNumber.errors" class="invalid-feedback">
                      <div
                        *ngIf="(itemsAddsFormControl.grnNumber.dirty || itemsAddsFormControl.grnNumber.touched) && itemsAddsFormControl.grnNumber.errors?.pattern">
                        Please enter a valid GRN Number
                      </div>
                      <div
                        *ngIf="((itemsAddsFormControl.grnNumber.dirty || itemsAddsFormControl.grnNumber.touched) && itemsAddsFormControl.grnNumber.errors?.required && !itemsAddsFormControl.grnNumber.errors?.pattern && !submitted)">
                        GRN Number is required
                      </div>
                      <div
                        *ngIf="((submitted) && itemsAddsFormControl.grnNumber.errors?.required && !itemsAddsFormControl.grnNumber.errors?.pattern)">
                        GRN Number is required
                      </div>
                    </div>
                  </div>
                  <div class="form-group col-md-6">
                    <textarea [rows]="1" [cols]="30" pInputTextarea placeholder="Write Remarks"
                              formControlName="remarks" id="remarks" class="form-control">

                    </textarea>
                  </div>

                </div>
                <div class="form-row">
                  <div class="form-group col-md-3">
                    <p-dropdown [options]="active" formControlName="printBal" id="printBal" placeholder="Print Bal:"
                                optionLabel="name" [showClear]="true"></p-dropdown>
                    <div *ngIf="itemsAddsFormControl.printBal.errors" class="invalid-feedback">
                      <div
                        *ngIf="(itemsAddsFormControl.printBal.dirty || itemsAddsFormControl.printBal.touched) && itemsAddsFormControl.printBal.errors?.pattern">
                        Please Fill the field
                      </div>
                      <div
                        *ngIf="((itemsAddsFormControl.printBal.dirty || itemsAddsFormControl.printBal.touched) && itemsAddsFormControl.printBal.errors?.required && !itemsAddsFormControl.printBal.errors?.pattern && !submitted)">
                        Print Bal is required
                      </div>
                      <div
                        *ngIf="((submitted) && itemsAddsFormControl.printBal.errors?.required && !itemsAddsFormControl.printBal.errors?.pattern)">
                        Print Bal is required
                      </div>
                    </div>
                  </div>
                  <div class="form-group col-md-3">

                    <p-dropdown [options]="active" formControlName="invSize" id="invSize" placeholder="Print Bal:"
                                optionLabel="name" [showClear]="true"></p-dropdown>
                    <div *ngIf="itemsAddsFormControl.invSize.errors" class="invalid-feedback">
                      <div
                        *ngIf="(itemsAddsFormControl.invSize.dirty || itemsAddsFormControl.invSize.touched) && itemsAddsFormControl.invSize.errors?.pattern">
                        Please Fill the field
                      </div>
                      <div
                        *ngIf="((itemsAddsFormControl.invSize.dirty || itemsAddsFormControl.invSize.touched) && itemsAddsFormControl.invSize.errors?.required && !itemsAddsFormControl.invSize.errors?.pattern && !submitted)">
                        Inv Size is required
                      </div>
                      <div
                        *ngIf="((submitted) && itemsAddsFormControl.invSize.errors?.required && !itemsAddsFormControl.invSize.errors?.pattern)">
                        Inv Size is required
                      </div>
                    </div>
                  </div>
                  <div class="form-group col-md-3">
                    <input type="text" formControlName="orderCode" placeholder="Order Code:" class="form-control"
                           [ngClass]="{ 'is-invalid': (submitted && itemsAddsFormControl.orderCode.errors) || ((itemsAddsFormControl.orderCode.dirty || itemsAddsFormControl.orderCode.touched) && itemsAddsFormControl.orderCode.errors) }"/>
                    <div *ngIf="itemsAddsFormControl.orderCode.errors" class="invalid-feedback">
                      <div
                        *ngIf="(itemsAddsFormControl.orderCode.dirty || itemsAddsFormControl.orderCode.touched) && itemsAddsFormControl.orderCode.errors?.pattern">
                        Please enter a valid Order Code
                      </div>
                      <div
                        *ngIf="((itemsAddsFormControl.orderCode.dirty || itemsAddsFormControl.orderCode.touched) && itemsAddsFormControl.orderCode.errors?.required && !itemsAddsFormControl.orderCode.errors?.pattern && !submitted)">
                        OrderCode is required
                      </div>
                      <div
                        *ngIf="((submitted) && itemsAddsFormControl.orderCode.errors?.required && !itemsAddsFormControl.orderCode.errors?.pattern)">
                        Order Code is required
                      </div>
                    </div>
                  </div>
                </div>

                <div class=" table-responsive mt-4">
                  <table class="table table-bordered" style="width: 300%;">
                    <thead>
                    <tr>
                      <th scope="col">Action</th>
                      <th scope="col">#</th>
                      <th scope="col">Alias Name</th>
                      <th scope="col">Item Name</th>
                      <th scope="col">Packing</th>
                      <th scope="col">Batch</th>
                      <th scope="col">Expiry Date</th>
                      <th scope="col">QTY</th>
                      <th scope="col">Bonus</th>
                      <th scope="col">Purchase Price</th>
                      <th scope="col">Total Ex(Discount)</th>
                      <th scope="col">Discount (%)</th>
                      <th scope="col">Discount price</th>
                      <th scope="col">Retail Price</th>
                      <th scope="col">Total Price</th>
                      <th scope="col">Margin %</th>
                    </tr>
                    </thead>
                    <tbody style="height:300px" formArrayName="purchaseArray">
                    <tr *ngFor="let unit of purchaseForm.get(this.purchaseArrayName)['controls'];
                    let purchaseFormIndex = index;" [formGroupName]="purchaseFormIndex">
                      <td>
                        <span (click)="addPurchaseRow()" class="material-icons"
                              *ngIf="purchaseFormIndex===0 || purchaseFormIndex===purchaseForm.get(this.purchaseArrayName)['controls'].length - 1"> library_add </span>
                        <span class="material-icons" *ngIf="purchaseFormIndex > 0"
                              (click)="removesPurchaseRow(purchaseFormIndex)"> delete_forever </span>
                      </td>
                      <td>{{purchaseFormIndex + 1}}</td>
                      <td>
                        <p-autoComplete placeholder="Alias Name:" formControlName="aliasNameTable"
                                        [suggestions]="aliasLookUpNameResult"
                                        (onSelect)="populatePurchaseTableFields(unit.controls.aliasNameTable, purchaseFormIndex, 'alias')"
                                        (window:keypress)="onKey($event, purchaseFormIndex)"
                                        [ngClass]="{ 'is-invalid': (submitted &&  unit.controls.aliasNameTable.errors) || (( unit.controls.aliasNameTable.dirty
                                          ||  unit.controls.aliasNameTable.touched) &&  unit.controls.aliasNameTable.errors) }"
                                        (completeMethod)="searchAlias($event)" [dropdown]="true">
                          <ng-template let-profileClassification pTemplate="item">
                            {{profileClassification }}
                          </ng-template>
                        </p-autoComplete>
                      </td>
                      <td>
                        <p-autoComplete placeholder="Item Name:" formControlName="itemName"
                                        [suggestions]="itemLookUpNameResult"
                                        (onSelect)="populatePurchaseTableFields(unit.controls.itemName, purchaseFormIndex, 'item')"

                                        [ngClass]="{ 'is-invalid': (submitted &&  unit.controls.itemName.errors) || (( unit.controls.itemName.dirty
                                          ||  unit.controls.itemName.touched) &&  unit.controls.itemName.errors) }"
                                        (completeMethod)="searchItem($event)" [dropdown]="true">
                          <ng-template let-profileClassification pTemplate="item">
                            {{profileClassification }}
                          </ng-template>
                        </p-autoComplete>
                      </td>

                      <td>
                        <input type="number" formControlName="packing" readonly>
                      </td>
                      <td>
                        <input type="number" formControlName="batch">
                      </td>
                      <td>
                        <input type="date" formControlName="expiryDate">
                      </td>
                      <td>
                        <input type="number" formControlName="qty"
                               (change)="patchPurchaseTable(purchaseFormIndex)">
                      </td>
                      <td>
                        <input type="number" formControlName="bonus">
                      </td>
                      <td>
                        <input type="number" formControlName="purchasPrice"
                               (focusout)="patchPurchaseTable(purchaseFormIndex)">
                      </td>
                      <td>
                        <input type="number" formControlName="totalExcludingDiscount" readonly>
                      </td>
                      <td>
                        <input type="number" formControlName="descountPercentage"
                               (focusout)="patchPurchaseTable(purchaseFormIndex)">
                      </td>
                      <td>
                        <input type="number" formControlName="descountPrice" readonly>
                      </td>
                      <td>
                        <input type="number" formControlName="retailPrice"
                               (focusout)="patchPurchaseTable(purchaseFormIndex)">
                      </td>

                      <td>
                        <input type="number" formControlName="netPrice" readonly>
                      </td>
                      <td>
                        <input type="number" formControlName="marginPercentage" readonly>
                      </td>
                    </tr>
                    </tbody>
                    <tfoot style="vertical-align:bottom">
                    <tr>
                      <th scope="col">#</th>
                      <th scope="col">Button</th>
                      <th scope="col">Alias Name</th>
                      <th scope="col">Item Name</th>
                      <th scope="col">Packing</th>
                      <th scope="col">Batch</th>
                      <th scope="col">Expiry Date</th>
                      <th scope="col">{{(this.getTotalSumOfColumn(this.itemQuantityArray))}}</th>

                      <th scope="col">Bonus</th>
                      <th scope="col">Purchase Price</th>
                      <th scope="col">Total Ex(Discount)</th>
                      <th scope="col">Discount (%)</th>
                      <th scope="col">Discount price</th>
                      <th scope="col">Retail Price</th>
                      <th scope="col">{{this.getTotalSumOfColumn(this.netTotalArray)}}</th>
                      <th scope="col">Margin</th>
                    </tr>
                    </tfoot>
                  </table>
                </div>

                <div class="form-row mt-2">
                  <div class="form-group col-md-2">
                    <label>Stock</label>
                    <input class="form-control" formControlName="inventoryStock" readonly>
                  </div>
                  <div class="form-group col-md-2">
                    <label>Disc(%)</label>
                    <input type="number" step="0.01" class="form-control" formControlName="totalDiscountPercentage"
                           (focusout)="patchPurchaseForm('percent')">
                  </div>
                  <div class="form-group col-md-2">
                    <label>Flat Disc(-)</label>
                    <input type="number" class="form-control" formControlName="flatDisc"
                           (focusout)="patchPurchaseForm('flat')">
                  </div>
                  <div class="form-group col-md-2">
                    <label>Misc(+)</label>
                    <input type="number" class="form-control" formControlName="miscValue"
                           (change)="patchPurchaseForm('flat')">
                  </div>
                  <div class="form-group col-md-1">
                    <label>Inv GST(%)</label>
                    <input class="form-control" formControlName="inventoryGst">
                  </div>
                </div>
                <div class="form-row mt-2">
                  <div class="form-group col-md-2">
                    <label>Tot/Stock:</label>
                    <input class="form-control" formControlName="totalStock" readonly>
                  </div>
                  <div class="form-group col-md-2">
                    <label>Purchase Exp:</label>
                    <input type="number" class="form-control" formControlName="purchaseExpance"
                           (focusout)="patchPurchaseForm('flat')">
                  </div>
                  <div class="form-group col-md-4">
                    <label>Sale Price +S/Tax =Total</label>
                    <input class="form-control" formControlName="flatDisc">
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-md-2">
                    <label>Last Purchase Price:</label>
                    <input class="form-control" formControlName="lastPurchasePrice" readonly>
                  </div>
                  <div class="form-group col-md-2">
                    <label>Avg Price:</label>
                    <input class="form-control" formControlName="avgPrice" readonly>
                  </div>
                  <div class="form-group col-md-2">
                    <label><b>Grand Total:</b></label>
                    <input class="form-control" formControlName="grandTotal" readonly>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>


      </div>
      <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
        <div class="row">
          <div class="col-md-12">
            <div class="job-form job-form-b">
              this is other tab
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
